#!/bin/bash

printShortUsage()
{
    # Note: short followed by long option; if the user knows the short one, she can
    # skim the long one.
    printf 'Usage: %q %s\n' "$(basename "$1")" '"WHAT-PATTERN [CONTEXT ...]" [KHAL-ARGS ...] [-?|-h|--help]'
}
printUsage()
{
    # This is the short help when launched with no or incorrect arguments.
    # It is printed to stderr to avoid accidental processing.
    printShortUsage "$1" >&2
    printf >&2 '\nTry %q --help for more information.\n' "$(basename "$1")"
}
printLongUsage()
{
    # This is the long "man page" when launched with the help argument.
    # It is printed to stdout to allow paging with 'more'.
    cat <<HELPDESCRIPTION
Show all events whose title matches WHAT-PATTERN [NUMBER UNIT] [CONTEXT ...].
WHAT-PATTERN is a grep-style anchored basic regular expresion.
If there are NUMBER(s), extract all for each UNIT and show their sums.
Print a summary of the total duration and date range in which they were
scheduled.
HELPDESCRIPTION
    echo
    printShortUsage "$1"
    echo
    cat <<HELPTEXT
    --summary-only|-Y	Do not output the sum(s); just show the total effort and
			date range.
HELPTEXT
}

isSummaryOnly=
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printLongUsage "$0"; exit 0;;
	--no-color|--color)
			shift;;	# Ignore color flag; tally doesn't use highlighting.
	--summary-only|-Y)
			isSummaryOnly=t; shift;;
	--)		shift; break;;
	*)		break;;
    esac
done
if [[ "$1" =~ ^([^[:space:]]+)[[:space:]]+(.*)$ ]]; then
    what="${BASH_REMATCH[1]}"
    context="${BASH_REMATCH[2]:+ }${BASH_REMATCH[2]}"
else
    what="${1:?}"
    context='\([[:space:]].*\)\?'
fi; shift

getMatchExpr()
{
    local numberUnitMulti="${1?}"; shift
    printf %s "^\\(${what}\\)\\( [[:digit:]]\\+ [[:alpha:]]\\+\\)${numberUnitMulti}${context}\$"
}

export KHAL_GREP_DATERANGE=1970-01-01
[ "$isSummaryOnly" ] || \
    khal-grep --color=never --no-summary \
	--process 'field 1 2 3 4 5 6' \
	--process 'sumField --group-by -1 --result-first -2' \
	-e "$(getMatchExpr '')" \
	"$@"
khal-grep --color=never --summary-only \
    -e "$(getMatchExpr '\?')" \
    "$@"
