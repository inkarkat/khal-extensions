#!/bin/bash
set -o pipefail
shopt -qs extglob

: ${KHAL_DISTRIBUTION_DATERANGE:=3 months ago}
readonly ABSOLUTE_END=2099-12-31    # XXX: khal 0.13.0 scales linearly, and dates beyond the year 2999 cannot be parsed

printShortUsage()
{
    local commonArguments='[-e|--regexp PATTERN|TODO]'
    local distributionCommonArguments='[--color=(always|auto|never)|--no-color] [--as colorbox-calendar|green-[large-]calendar|...]'
    local distributionOverAutorangeArguments='[--no-footer|--final-footer-only|footer-only-on-change|--footer-every N] [--force-legends] [--bucket-legend] [--over day|month|year|year-weekly|--weekly]'
    local distributionAutolinearArguments='-l|--linear [-w|--width W] [--no-today-base-date|--base-date today|"YYYY MM DD"] [--no-start-date] [--no-end-date] [--days-per-slot N|--slots-per-day N] [--reversed]'
    local khalArguments='[KHAL-ARGS ...]'
    # Note: short followed by long option; if the user knows the short one, she can
    # skim the long one.
    printf 'Usage: %q %s %s %s %s %s\n' "$(basename "$1")" "$commonArguments" "$distributionOverAutorangeArguments" "${distributionCommonArguments[@]}" "$khalArguments" '[-?|-h|--help]'
    echo
    printf 'Usage: %q %s %s %s %s %s\n' "$(basename "$1")" "$commonArguments" "$distributionAutolinearArguments" "${distributionCommonArguments[@]}" "$khalArguments" '[-?|-h|--help]'
}
printUsage()
{
    # This is the short help when launched with no or incorrect arguments.
    # It is printed to stderr to avoid accidental processing.
    printShortUsage "$1" >&2
    printf >&2 '\nTry %q --help for more information.\n' "$(basename "$1")"
}
printLongUsage()
{
    # This is the long "man page" when launched with the help argument.
    # It is printed to stdout to allow paging with 'more'.
    cat <<HELPDESCRIPTION
Print the distribution of event durations that fall into the graphed range.
Depending on the range, this will be the distribution over the day, month, or
over year(s) (for anything longer). All-day events are ignored.
HELPDESCRIPTION
    echo
    printShortUsage "$1"
    echo
    cat <<HELPTEXT
    --regexp|-e PATTERN	Graph the total duration of all events that match
			PATTERN.
    --tally "WHAT-PATTERN [CONTEXT ...]"
			Graph all events whose title matches WHAT-PATTERN
			[NUMBER UNIT] [CONTEXT ...].
			WHAT-PATTERN is a grep-style anchored basic regular
			expresion. If there are NUMBER(s), add up all regardless
			of their UNIT(s); without NUMBER, just count them.
    --unit UNIT		Just add up WHAT-PATTERN matches for the passed UNIT;
			ignore all other units or matches without NUMBER.
    --linear|-l		Choose a linear representation in one line with
			auto-scaling of the time instead of the fixed reporting
			over day, month, years.
    --no-today-base-date
			Disable basing the end of the range on today (which
			makes for a uniform alignment of multiple graphs (unless
			reversed), but can squash the scale if the actual range
			is deep in the past).
HELPTEXT
}

distributionCommand=distribution-over-autorange
typeset -a distributionArgs=()
typeset -a distributionBaseDateArg=()
typeset -a distributionReversedArg=()
typeset -a distributionMinArg=(--min 0)
typeset -a khalArgs=()
typeset -a sourceLogCommand=(getDurations)
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printLongUsage "$0"; exit 0;;
	--linear|-l)	shift; distributionCommand=distribution-autolinear; distributionBaseDateArg=(--base-date today); distributionReversedArg=(--reversed);;

	-[S])           distributionArgs+=("$1"); shift;;
	--@(no-footer|final-footer-only|footer-only-on-change|no-splitting|weekly|force-legends|no-start-date|no-end-date|no-day-zoom|no-color|color=*))
			distributionArgs+=("$1"); shift;;
	-[w])           distributionArgs+=("$1" "$2"); shift; shift;;
	--@(bucket-legend|footer-every|graph-legend|footer-legend|as|over|width|days-per-slot|slots-per-day|max|scale))
			distributionArgs+=("$1" "$2"); shift; shift;;
	--color)	shift; distributionArgs+=(--color=always);;
	--min)		distributionMinArg=("$1" "$2"); shift; shift;;
	--base-date)	distributionBaseDateArg=("$1" "$2"); shift; shift;;
	--no-today-base-date)
			distributionBaseDateArg=(); shift;;
	--reversed)	shift; distributionReversedArg=();;

	--)		khalArgs+=("$1"); shift; break;;
	*)		khalArgs+=("$1"); shift;;
    esac
done
khalArgs+=("$@")

wholeAndMultiDayToZero()
{
    fieldMap -F '\t' 2 '$fieldNr >= 86400 ? 0 : $fieldNr'
}

getDurations()
{
    # Note: Do not use --once here; for multi-day events, we'll want to count every
    # day separately and instead set it's length to 0.
    khal-wrapper list --no-color --day-format '' --format $'{start-date-long} {start-time-full}\t{end-date-long} {end-time-full}' "${khalArgs[@]}" "${KHAL_RANGE_START:-$(date --date "${KHAL_DISTRIBUTION_DATERANGE:?}" +%F)}" "${KHAL_RANGE_END:-$ABSOLUTE_END}" \
	| reldate --relative-to-first --difference \
	| wholeAndMultiDayToZero
}

getLogs()
{
    "${sourceLogCommand[@]}"
}


printGraph()
{
    $distributionCommand --count-field 6 "${distributionBaseDateArg[@]}" "${distributionReversedArg[@]}" "${distributionMinArg[@]}" "${distributionArgs[@]}"
}

# getLogs; exit
getLogs | printGraph
